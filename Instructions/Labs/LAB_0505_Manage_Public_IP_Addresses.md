---
lab:
    title: 'Lab: Azure Stack Hub でパブリック IP アドレスを管理する'
    module: 'モジュール 5: インフラストラクチャを管理する'
---

# ラボ - Azure Stack Hub でパブリック IP アドレスを管理する
# 受講生用ラボ マニュアル

## ラボの依存関係

- なし

## 推定所要時間

30 分

## ラボ シナリオ

あなたは Azure Stack Hub 環境のオペレーターとして、パブリック IP アドレス リソースを管理する必要があります。 

## 目標

このラボを終了すると、次のことができるようになります。

- パブリック IP アドレス リソースを管理する

## ラボ環境

このラボでは、Active Directory フェデレーション サービス (AD FS) (ID プロバイダーとしてバックアップされた Active Directory) に統合された ADSK インスタンスを使用します。 

ラボ環境は、次のコンポーネントから構成されています。

- 次のアクセス ポイントを持つ、**AzS-HOST1** サーバーで実行されている ASDK デプロイ。

  - 管理者ポータル: https://adminportal.local.azurestack.external
  - 管理者 ARM エンドポイント: https://adminmanagement.local.azurestack.external
  - ユーザー ポータル: https://portal.local.azurestack.external
  - ユーザー ARM エンドポイント: https://management.local.azurestack.external

- 管理ユーザー:

  - ASDK クラウド オペレーターのユーザー名: **CloudAdmin@azurestack.local**
  - ASDK クラウド オペレーターのパスワード: **Pa55w.rd1234**
  - ASDK ホスト管理者のユーザー名: **AzureStackAdmin@azurestack.local**
  - ASDK ホスト管理者のパスワード: **Pa55w.rd1234**

このラボでは、PowerShell を介して Azure Stack Hub を管理するために必要なソフトウェアをインストールします。追加のユーザー アカウントも作成します。

## 手順

### 演習 0: ラボの準備を行う

この演習では、ラボで使用するための Active Directory ユーザー アカウントを作成します。

1. (クラウド オペレーターとして) ユーザー アカウントを作成する

#### タスク 1: (クラウド オペレーターとして) ユーザー アカウントを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) ユーザー アカウントを作成する

1. 必要であれば、次の資格情報を使用して **AzS-HOST1** にサインインします。

    - ユーザー名: **AzureStackAdmin@azurestack.local**
    - パスワード: **Pa55w.rd1234**

1. **AzS-HOST1** へのリモート デスクトップ セッション内でスタート メニューの「**スタート**」をクリックし、「**Windows 管理ツール**」をクリックしてから、管理ツールの一覧で「**Active Directory 管理センター**」をダブルクリックします。
1. 「**Active Directory 管理センター**」コンソールで「**azurestack (ローカル)**」をクリックします。
1. 詳細ペインで「**ユーザー**」コンテナーをダブルクリックします。
1. 「**タスク**」ペインの「**ユーザー**」セクションで、**「新規作成」>「ユーザー」**の順にクリックします。
1. 「**ユーザーの作成**」ウィンドウで、次のように設定してから「**OK**」をクリックします。 

    - 完全名: **T1U1**
    - ユーザー UPN ログオン: **t1u1@azurestack.local**
    - ユーザー SamAccountName: **azurestack\t1u1**
    - パスワード: **Pa55w.rd**
    - パスワード オプション: **その他のパスワード オプション -> パスワードを無期限にする**

>**確認**: この演習では、ラボで使用するための Active Directory アカウントを作成しました。


### 演習 1: (クラウド オペレーターとして) オファーを作成する

この演習では、クラウド オペレーターの役を担います。最初に、パブリック IP アドレスの使用状況を確認してから、ネットワーク サービスが含まれるプランを作成した後、このプランが含まれるオファーを作成します。続いて、オファーをパブリックに設定することで、ユーザーがこのオファーに基づいてサブスクリプションを作成できるようにします。この演習は以下のタスクから構成されます。

1. (クラウド オペレーターとして) パブリック IP アドレスの使用状況を確認する
1. (クラウド オペレーターとして) ネットワーク サービスから構成されるプランを作成する
1. (クラウド オペレーターとして) プランに基づいたオファーを作成し、このオファーをパブリックに設定する


#### タスク 1: (クラウド オペレーターとして) パブリック IP アドレスの使用状況を確認する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) パブリック IP アドレスの使用状況を確認する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーを開いて画面に [Azure Stack Hub 管理者ポータル](https://adminportal.local.azurestack.external/)を表示させ、CloudAdmin@azurestack.local としてサインインします。
1. Azure Stack Hub 管理者ポータルの「**ダッシュボード**」ページで、「**リソース プロバイダー**」タイルの「**ネットワーク**」をクリックします。 
1. 「**ネットワーク**」ブレードで、「**パブリック IP プールの使用量**］グラフと、使用中および未使用の IP アドレスの数を確認します。

#### タスク 2: (クラウド オペレーターとして) ネットワーク サービスから構成されるプランを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) ネットワーク サービスから構成されるプランを作成する

1. Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**+ リソースの作成**」をクリックします。 
1. 「**新規**」ブレードで「**オファーとプラン**」をクリックします。
1. 「**オファーとプラン**」ブレードで「**プラン**」をクリックします
1. 「**新しいプラン**」ブレードの「**基本**」タブで、次のように設定を行います。

    - 表示名: **Network-plan1**
    - リソース名: **network-plan1**
    - リソース グループ: 新しいリソース グループの名前 **network-plans-RG**

1. 「**次へ: サービス >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**サービス**」タブで、「**Microsoft.Network**」チェックボックスをオンにします。
1. 「**次へ: クォータ >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**クォータ**」タブで、「**新規作成**」チェックボックスをオンにします。
1. 「**ネットワーク クォータの作成**」ブレードで、次のように設定してから「**OK**」をクリックします。

    - 名前: **Network-plan1-quota**
    - 仮想ネットワークの最大数: **2**
    - 仮想ネットワーク ゲートウェイの最大数: **2**
    - ネットワーク接続の最大数 **2**
    - パブリック IP の最大数: **20**
    - NIC の最大数:**
    - ロード バランサーの最大数: **5**
    - ネットワーク セキュリティ グループの最大数: **20**

1. 「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。


#### タスク 3: (クラウド オペレーターとして) プランに基づいたオファーを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) プランに基づいたオファーを作成する

1. Azure Stack Hub 管理者ポータルで「**+ リソースの作成**」をクリックします。 
1. 「**新規**」ブレードで「**オファーとプラン**」をクリックします。
1. 「**オファーとプラン**」ブレードで「**オファー**」をクリックします
1. 「**新しいオファーの作成**」ブレードの「**基本**」タブで、次のように設定を行います。

    - 表示名: **Network-offer1**
    - リソース名: **network-offer1**
    - リソース グループ: **network-offers-RG** という名前の新しいリソース グループ
    - このオファーをパブリックに設定する: **はい**

1. 「**次へ: 基本プラン >**」をクリックします。 
1. 「**新しいオファーの作成**」ブレードの「**基本プラン**」タブで、「**Network-plan1**」エントリの横にあるチェックボックスをオンにします。
1. 「**次へ: アドオン プラン >**」をクリックします。
1. 「**アドオン プラン**」の設定は既定値にしたまま、「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。

>**確認**: この演習では、プランを作成し、そのプランに基づいてパブリック オファーを作成しました。


### 演習 2: (ユーザーとして) パブリック IP アドレス リソースを作成する

この演習ではユーザーとして、最初の演習で作成したオファーにサインアップした後、新しいサブスクリプションを作成してから、このサブスクリプションのもとでパブリック IP アドレス リソースを作成します。この演習は以下のタスクから構成されます。

1. (ユーザーとして) オファーにサインアップする
1. (ユーザーとして) Azure Stack Hub ユーザーの Azure Resource Manager エンドポイントに接続する
1. (ユーザーとして) IP アドレス リソースを作成する

#### タスク 1: (ユーザーとして) オファーにサインアップする

このタスクでは、次のことを行います。

- (ユーザーとして) オファーにサインアップする

1. 1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの InPrivate セッションを開始します。
1. Web ブラウザー ウィンドウで [Azure Stack Hub ユーザー ポータル](https://portal.local.azurestack.external)に移動した後、**t1u1@azurestack.local** としてサインインし、パスワードに **Pa55w.rd** と入力します。
1. Azure Stack Hub ユーザー ポータルのダッシュボードで、「**サブスクリプションの取得**」をクリックします。
1. 「**サブスクリプションの取得**」ブレードの「**表示名**」テキスト ボックスに「**T1U1-network-subscription1**」と入力します。
1. オファーの一覧で「**Network-offer1**」を選択し、「**作成**」をクリックします。
1. 「**サブスクリプションが作成されました。サブスクリプションの使用を開始するに、ポータルを更新する必要があります**」メッセージ ボックスで「**更新**」をクリックします。


#### タスク 2: (ユーザーとして) Azure Stack Hub の Azure Resource Manager ユーザー エンドポイントに接続する

このタスクでは、次のことを行います。

- (ユーザーとして) Azure Stack Hub の Azure Resource Manager ユーザー エンドポイントに接続する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、管理者として PowerShell 7 を起動します。

    >**注**: PowerShell の Azure Stack Hub への接続を設定する方法について詳しくは、「**PowerShell を介して Azure Stack Hub に接続する**」のラボ手順を参照してください。

1. 「**管理者: C:\Program Files\PowerShell\7\pwsh.exe**」プロンプトで以下のコマンドを実行して、このラボに必要な Azure Stack Hub PowerShell モジュールをインストールします。

    ```powershell
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    Install-Module -Name Az.BootStrapper -Force -AllowPrerelease -AllowClobber
    Install-AzProfile -Profile 2019-03-01-hybrid -Force
    Install-Module -Name AzureStack -RequiredVersion 2.0.2-preview -AllowPrerelease
    ```

    >**注**: すでに利用可能となっているコマンドに関するエラー メッセージはすべて無視してください。

1. 「**管理者: C:\Program Files\PowerShell\7\pwsh.exe**」プロンプトで以下のコマンドを実行して、Azure Stack Hub ツールをダウンロードして展開します。

    ```powershell
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    Set-Location -Path 'C:\'
    Invoke-WebRequest https://github.com/Azure/AzureStack-Tools/archive/az.zip -OutFile az.zip
    Expand-Archive az.zip -DestinationPath . -Force
    Set-Location -Path '\AzureStack-Tools-az'
    ```

1. 「**管理者: C:\Program Files\PowerShell\7\pwsh.exe**」プロンプトで以下のコマンドを実行して、Azure Stack Hub ユーザー環境を登録します。

    ```powershell
    Add-AzEnvironment -Name 'AzureStackUser' -ArmEndpoint 'https://management.local.azurestack.external'
    ```

1. 「**管理者: C:\Program Files\PowerShell\7\pwsh.exe**」プロンプトで以下のコマンドを実行して、**t1u1@azurestack.local** ユーザーとして、ブラウザー セッションを介して Azure Stack Hub ユーザー環境の認証を開始します。

    ```powershell
    Connect-AzAccount -EnvironmentName 'AzureStackUser' -UseDeviceAuthentication
    ```

1. 「**管理者: C:\Program Files\PowerShell\7\pwsh.exe**」ウィンドウで、生成されたメッセージを確認し、Web ブラウザーの別の画面を InPrivate モードで開いて「[adfs.local.azurestack.external](https://adfs.local.azurestack.external/adfs/oauth2/deviceauth)」ページに移動し、確認したメッセージに記されているコードを入力します。サインインを求められたら、**t1u1@azurestack.local** ユーザーとして再度サインインします。
1. 「**管理者: C:\Program Files\PowerShell\7\pwsh.exe**」ウィンドウに戻り、**t1u1@azurestack.local** ユーザーとして認証されたことを確認します。


#### タスク 3: (ユーザーとして) IP アドレス リソースを作成する

このタスクでは、次のことを行います。

- (ユーザーとして) IP アドレス リソースを作成する

1. 「**管理者: C:\Program Files\PowerShell\7\pwsh.exe**」プロンプトで以下のコマンドを実行して、新たにプロビジョニングしたサブスクリプションを使用していることを確認します。 

    ```powershell
    (Get-AzSubscription).Name
    ```

1. 「**管理者: C:\Program Files\PowerShell\7\pwsh.exe**」プロンプトで以下のコマンドを実行して、現在のサブスクリプションのもとでネットワーク リソース プロバイダーを登録します。

    ```powershell 
    Register-AzResourceProvider -ProviderNamespace Microsoft.Network
    ```

    >**注**: リソース プロバイダーを登録しない限り、そのプロバイダーによって管理されるリソースを作成することはできません。

1. 「**管理者: C:\Program Files\PowerShell\7\pwsh.exe**」プロンプトで以下のコマンドを実行して、パブリック IP アドレス リソースをホストするリソース グループを作成します。

    ```powershell 
    $rg = New-AzResourceGroup -Name publicIPs-RG -Location local
    ```

1. 「**管理者: C:\Program Files\PowerShell\7\pwsh.exe**」プロンプトで以下のコマンドを実行して、パブリック IP アドレス リソースを作成します。 

    ```powershell
    1..5 | ForEach-Object {New-AzPublicIpAddress -Name "publicIP$_" -ResourceGroupName $rg.ResourceGroupName -AllocationMethod Static -Location local}
    ```

1. すべての IP アドレス リソースがプロビジョニングされるまで待ちます。

>**確認**: この演習では、ユーザーのサブスクリプションのもとでパブリック IP アドレス リソースを作成しました。


### 演習 4: (クラウド オペレーターとして) パブリック IP アドレスの使用状況を管理する

この演習ではクラウド オペレーターとして、パブリック IP アドレスの使用状況を確認および管理します。この演習は以下のタスクから構成されます。

1. パブリック IP アドレス リソースの使用状況を確認する
2. パブリック IP アドレス プールを追加する

#### タスク 1: (クラウド オペレーターとして) パブリック IP アドレスの使用状況を確認する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) パブリック IP アドレスの使用状況を確認する

1. Azure Stack Hub 管理者ポータルが表示されている Web ブラウザーの画面に切り替えます (ここでは CloudAdmin@azurestack.local としてサインインしています)。
1. Azure Stack Hub 管理者ポータルのハブ メニューで「**ダッシュボード**」をクリックし、「**リソース プロバイダー**」タイルの「**ネットワーク**」をクリックします。
1. 「**ネットワーク**」ブレードで、「**パブリック IP プールの使用量**］グラフと、使用中および未使用の IP アドレスの数を再度確認します。

    >**注**: ユーザー サブスクリプションのもとで (ユーザーとして) 5 つの追加のパブリック IP アドレスを作成したことで、数が変化しているはずです。

#### タスク 2: (クラウド オペレーターとして) パブリック IP アドレス プールを追加する

このタスクでは、次のことを行います。

- パブリック IP アドレス プールを追加する

1. Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**ネットワーク**」ブレードの「**パブリック IP プールの使用量**」タイルを選択します。

    >**注**: 「**パブリック IP プール**」ブレードに「**「スタートアップ」の排他的操作が進行中です。この操作の実行中は、ノードを追加する操作や IP プールを追加する操作は実行できません。ここをクリックしてアクティビティ ログを確認してください**」のメッセージが表示された場合は、「スタートアップ」操作が完了するまで次の手順に進むことはできません。

1. 「**パブリック IP プール**」ブレードで「**+ IP プールの追加**」をクリックします。 
1. 「**IP プールの追加**」ブレードで、次のように設定してから「**追加**」をクリックします。

    - 名前: **Public Pool 1**
    - リージョン: **ローカル**
    - アドレス範囲 (CIDR ブロック): **192.168.110.0/24**

1. 変更が適用されるまで待ってから、「**ネットワーク**」ブレードに戻ります。
1. 「**パブリック IP プールの使用量**」グラフで、未使用の IP アドレスの数の変化を確認します。

>**確認**: この演習では、パブリック IP アドレス プールを確認して構成しました。