---
lab:
    title: 'ラボ: Azure Stack Hub でオファー管理の役割を委任する'
    module: 'モジュール 4: ID とアクセスを管理する'
---

# ラボ - Azure Stack Hub でオファー管理の役割を委任する
# 受講生用ラボ マニュアル

## ラボの依存関係

- なし

## 推定所要時間

45 分

## ラボ シナリオ

あなたは Azure Stack Hub 環境のオペレーターとして、オファーを管理する役割を、社内のテクニカル サポート スタッフに委任する必要があります。

## 目標

このラボを終了すると、次のことができるようになります。

- Azure Stack Hub でオファーの委任を実装する

## ラボ環境 

ラボ環境は、次のコンポーネントから構成されています。

- 次のアクセス ポイントを持つ、**AzS-HOST1** サーバーで実行されている ASDK デプロイ。

  - 管理者ポータル: https://adminportal.local.azurestack.external
  - 管理者 ARM エンドポイント: https://adminmanagement.local.azurestack.external
  - ユーザー ポータル: https://portal.local.azurestack.external
  - ユーザー ARM エンドポイント: https://management.local.azurestack.external

- 管理ユーザー:

  - ASDK クラウド オペレーターのユーザー名: **CloudAdmin@azurestack.local**
  - ASDK クラウド オペレーターのパスワード: **Pa55w.rd1234**
  - ASDK ホスト管理者のユーザー名: **AzureStackAdmin@azurestack.local**
  - ASDK ホスト管理者のパスワード: **Pa55w.rd1234**

このラボでは、追加のユーザー アカウントを作成します。

### 演習 0: ラボの準備を行う

この演習では、ラボで使用するための Active Directory ユーザー アカウントを作成します。

1. (クラウド オペレーターとして) 委任された管理者ユーザー アカウントを作成する
1. (クラウド オペレーターとして) テナント ユーザー アカウントを作成する


#### タスク 1: (クラウド オペレーターとして) 委任された管理者ユーザー アカウントを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) 委任された管理者ユーザー アカウントを作成する

1. 必要であれば、次の資格情報を使用して **AzS-HOST1** にサインインします。

    - ユーザー名: **AzureStackAdmin@azurestack.local**
    - パスワード: **Pa55w.rd1234**

1. **AzS-HOST1** へのリモート デスクトップ セッション内でスタート メニューの「**スタート**」をクリックし、「**Windows 管理ツール**」をクリックしてから、管理ツールの一覧で「**Active Directory 管理センター**」をダブルクリックします。
1. 「**Active Directory 管理センター**」コンソールで「**azurestack (ローカル)**」をクリックします。
1. 詳細ペインで「**ユーザー**」コンテナーをダブルクリックします。
1. 「**タスク**」ペインの「**ユーザー**」セクションで、**「新規作成」>「ユーザー」** の順にクリックします。
1. 「**ユーザーの作成**」ウィンドウで、次のように設定してから「**OK**」をクリックします。 

    - 完全名: **DP1**
    - ユーザー UPN ログオン: **dp1@azurestack.local**
    - ユーザー SamAccountName: **azurestack\dp1**
    - パスワード: **Pa55w.rd**
    - パスワード オプション: **その他のパスワード オプション -> パスワードを無期限にする**


#### タスク 2: (クラウド オペレーターとして) テナント ユーザー アカウントを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) テナント ユーザー アカウントを作成する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、「**Active Directory 管理センター**」コンソールに移動し、「**タスク**」ペインの「**ユーザー**」セクションで **「新規」>「ユーザー」** の順にクリックします。
1. 「**ユーザーの作成**」ウィンドウで、次のように設定してから「**OK**」をクリックします。 

    - 完全名: **T1U1**
    - ユーザー UPN ログオン: **t1u1@azurestack.local**
    - ユーザー SamAccountName: **azurestack\t1u1**
    - パスワード: **Pa55w.rd**
    - パスワード オプション: **その他のパスワード オプション -> パスワードを無期限にする**

>**確認**: この演習では、ラボで使用するための Active Directory アカウントを作成しました。


### 演習 1: (クラウド オペレーターとして) 委任されたプロバイダーを指定する

この演習ではクラウド オペレーターとして、**サブスクリプション** サービスとその関連オファーから構成されるプランを作成します。次に、新しいオファーが含まれるサブスクリプションを作成して、委任されたプロバイダーをそのサブスクライバーとして指定します。

1. (クラウド オペレーターとして) サブスクリプション サービスから構成されるプランを作成する
1. (クラウド オペレーターとして) プランに基づいたオファーを作成する
1. (委任されたプロバイダーとして) オファーが含まれる新しいサブスクリプションを作成する


#### タスク 1: (クラウド オペレーターとして) サブスクリプション サービスから構成されるプランを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) サブスクリプション サービスから構成されるプランを作成する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーを開いて画面に [Azure Stack Hub 管理者ポータル](https://adminportal.local.azurestack.external/)を表示させ、CloudAdmin@azurestack.local としてサインインします。
1. Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**+ リソースの作成**」をクリックします。 
1. 「**新規**」ブレードで「**オファーとプラン**」をクリックします。
1. 「**オファーとプラン**」ブレードで「**プラン**」をクリックします
1. 「**新しいプラン**」ブレードの「**基本**」タブで、次のように設定を行います。

    - 表示名: **co-subscription-plan**
    - リソース名: **co-subscription-plan**
    - リソース グループ: 新しいリソース グループの名前 **co-subscription-RG**

1. 「**次へ: サービス >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**サービス**」タブで、「**Microsoft.Subscriptions**」チェックボックスをオンにします。
1. 「**次へ: クォータ >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**クォータ**」タブで、「**Microsoft.Subscriptions**」ドロップダウン リストから「**delegatedProviderQuota**」を選択します。 
1. 「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。

#### タスク 2: (クラウド オペレーターとして) プランに基づいたオファーを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) プランに基づいたオファーを作成する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**+ リソースの作成**」をクリックします。 
1. 「**新規**」ブレードで「**オファーとプラン**」をクリックします。
1. 「**オファーとプラン**」ブレードで「**オファー**」をクリックします
1. 「**新しいオファーの作成**」ブレードの「**基本**」タブで、次のように設定を行います。

    - 表示名: **cotodp-subscription-offer**
    - リソース名: **cotodp-subscription-offer**
    - リソース グループ: **co-subscription-RG**
    - このオファーをパブリックに設定する: **はい**

1. 「**次へ: 基本プラン >**」をクリックします。 
1. 「**新しいオファーの作成**」ブレードの「**基本プラン**」タブで、「**aco-subscription-plan**」エントリの横にあるチェックボックスをオンにします。
1. 「**次へ: アドオン プラン >**」をクリックします。
1. 「**アドオン プラン**」の設定は既定値にしたまま、「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。

#### タスク 3: (クラウド オペレーターとして) オファーが含まれる新しいサブスクリプションを作成し、委任されたプロバイダーをそのサブスクライバーとして追加する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) オファーが含まれる新しいサブスクリプションを作成し、委任されたプロバイダーをそのサブスクライバーとして追加する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**+ リソースの作成**」をクリックします。 
1. 「**新規**」ブレードで「**オファーとプラン**」をクリックします。
1. 「**オファーとプラン**」ブレードで「**サブスクリプション**」をクリックします
1. 「**ユーザー サブスクリプションの作成**」ブレードで、次のように設定を行います。

    - 名前: **dp1-subscription1**
    - ユーザー: **dp1@azurestack.local**
    - ディレクトリ テナント: **ADFS.azurestack.local**

1. パブリック オファーの一覧で、「**cotodp-subscription-offer**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。

>**確認**: この演習では、委任されたプロバイダーを指定しました。


### 演習 2: (クラウド オペレーターとして) 委任されたオファーを作成し、これを委任されたプロバイダーに提供する

この演習ではクラウド オペレーターとして、サービスが含まれるオファーを作成した後、委任されたプロバイダーはこれを自身のテナントに提供します。

1. (クラウド オペレーターとして) 委任するためのプランを作成する
1. (クラウド オペレーターとして) プランに基づいたオファーを作成する
1. (クラウド オペレーターとして) オファーを、委任されたプロバイダーに委任する

#### タスク 1: (クラウド オペレーターとして) 委任するためのプランを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) 委任するためのプランを作成する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**+ リソースの作成**」をクリックします。 
1. 「**新規**」ブレードで「**オファーとプラン**」をクリックします。
1. 「**オファーとプラン**」ブレードで「**プラン**」をクリックします
1. 「**新しいプラン**」ブレードの「**基本**」タブで、次のように設定を行います。

    - 表示名: **co-services1-plan**
    - リソース名: **co-services1-plan**
    - リソース グループ: 新しいリソース グループの名前 **co-services-RG**

1. 「**次へ: サービス >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**サービス**」タブで、「**Microsoft.Storage**」チェックボックスをオンにします。
1. 「**次へ: クォータ >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**クォータ**」タブで、「**Microsoft.Storage**」ドロップダウン リストの横にある「**新規作成**」をクリックします。
1. 「**ストレージ クォータの作成**」ブレードで、次のように設定してから「**OK**」をクリックします。

    - 名前: **co-services1-storage-quota**
    - 最大容量 (GB): **200**
    - ストレージ アカウントの合計数: **1**

1. 「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。


#### タスク 2: (クラウド オペレーターとして) プランに基づいたオファーを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) プランに基づいたオファーを作成する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**+ リソースの作成**」をクリックします。 
1. 「**新規**」ブレードで「**オファーとプラン**」をクリックします。
1. 「**オファーとプラン**」ブレードで「**オファー**」をクリックします
1. 「**新しいオファーの作成**」ブレードの「**基本**」タブで、次のように設定を行います。

    - 表示名: **cotodp-services1-offer**
    - リソース名: **cotodp-services1-offer**
    - リソース グループ: **co-services-RG**
    - このオファーをパブリックに設定する: **はい**

1. 「**次へ: 基本プラン >**」をクリックします。 
1. 「**新しいオファーの作成**」ブレードの「**基本プラン**」タブで、「**co-services1-plan**」エントリの横にあるチェックボックスをオンにします。
1. 「**次へ: アドオン プラン >**」をクリックします。
1. 「**アドオン プラン**」の設定は既定値にしたまま、「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。


#### タスク 3: (クラウド オペレーターとして) オファーを、委任されたプロバイダーに委任する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) オファーを、委任されたプロバイダーに委任する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、ハブ メニューの「**オファー**」クリックします。 
1. 「**オファー**」ブレードで「**cotodp-services1-offer**」をクリックします
1. 「**cotodp-services1-offer**」ブレードで「**委任されたプロバイダー**」をクリックします。
1. 「**cotodp-services1-offer \| 委任されたプロバイダー**」ブレードで「**+ 追加**」をクリックします。
1. 「**オファーの委任**」ブレードで、次のように設定してから「**委任**」をクリックします。

    - 名前: **cotodp-services1-offer**
    - 委任されたプロバイダーのサブスクリプションを選択: **dp1-subscription1**

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。

>**確認**: この演習ではオファーを作成し、このオファーを、委任されたプロバイダーに委任しました。


### 演習 3: (委任されたプロバイダーとして) 委任されたオファーをテナント向けに作成する

この演習では委任されたプロバイダーとして、(クラウド オペレーターから提供されたオファーに基づいて) オファーを作成します。このオファーは後に、テナントがサブスクライブできるようになります。

1. (クラウド プロバイダーとして) 委任されたプロバイダーのオファーをテナント向けに作成する
1. (委任されたプロバイダーとして) 委任されたプロバイダーのポータルの URL を特定する

#### タスク 1: (委任されたプロバイダーとして) 委任されたプロバイダーのオファーをテナント向けに作成する

このタスクでは、次のことを行います。

- 委任されたプロバイダー用のクラウド オペレーター オファーに基づき、(委任されたプロバイダーとして) テナント用のオファーを作成する

これにより、委任されたプロバイダーのオファーに基づいて、テナントがサブスクリプションを作成できるようになります。

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの InPrivate セッションを開始します。
1. Web ブラウザー ウィンドウで [Azure Stack Hub ユーザー ポータル](https://portal.local.azurestack.external)に移動した後、**dp1@azurestack.local** としてサインインし、パスワードに **Pa55w.rd** と入力します。
1. Azure Stack Hub ユーザー ポータルのハブ メニューで「**すべてのサービス**」をクリックしてから、「**すべてのサービス**」ブレードで「**オファー**」をクリックします。
1. 「**オファー**」ブレードで「**+ 追加**」をクリックします。
1. 「**新しいオファーの作成**」ブレードで、次のように設定を行います。

    - 表示名: **dp1tot-services1-offer**
    - リソース名: **dp1tot-services1-offer**
    - プロバイダー サブスクリプション: **dp1-subscription1**
    - リソース グループ: 新しいリソース グループの名前 **dp1-RG**

1. 「**委任されたオファー**」をクリックします。
1. 「**委任されたオファー**」ブレードで「**cotodp-services1-offer**」をクリックします
1. 「**新しいオファーの作成**」ブレードに戻って「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。

1. Azure Stack Hub ユーザー ポータルの「**オファー**」ブレードに戻り、「**更新**」をクリックしてから、新たに作成されたオファー「**dp1tot-services1-offer**」をクリックします。
1. 「**dp1tot-services1-offer**」ブレードで「**状態の変更**」をクリックし、ドロップダウン リストで「**パブリック**」をクリックします。


#### タスク 2: (委任されたプロバイダーとして) 委任されたプロバイダーのポータルの URL を特定する

このタスクでは、次のことを行います。

- (委任されたプロバイダーとして) 委任されたプロバイダーのポータルの URL を特定する

1. Azure Stack Hub ユーザー ポータルに **dp1@azurestack.local** としてサインインした状態で、ハブ メニューの「**すべてのサービス**」をクリックしてから、「**すべてのサービス**」ブレードのサービスの一覧で「**サブスクリプション**」をクリックします。
1. 「**サブスクリプション**」ブレードで「**dp1-subscription1**」をクリックします。
1. 委任されたプロバイダーのサブスクリプションである「**dp1-subscription1**」ブレードで、「**プロパティ**」をクリックします。
1. 「プロパティ」ブレードで、「**ポータル URL**」の値をクリップボードにコピーします。これは、このラボの次の演習で必要となります。 
1. Azure Stack Hub ユーザー ポータルの右上にあるユーザー アバター アイコンをクリックし、ドロップダウン メニューで「**サインアウト**」をクリックします。

    >**注**: テナントは、委任されたプロバイダーのポータル URL で提供されているオファーをサブスクライブする必要があります。

>**確認**: この演習では、委任されたプロバイダーのオファーを作成しました。


### 演習 4: (テナント ユーザーとして) 委任されたプロバイダーのオファーにサインアップする

この演習ではテナント ユーザーとして、委任されたプロバイダーのオファーにサインアップし、新しいサブスクリプションのもとでリソースを作成します。この演習は以下のタスクから構成されます。

1. (テナント ユーザーとして) 委任されたプロバイダーのオファーにサインアップする
1. (テナント ユーザーとして) 新しいサブスクリプションのもとでリソースを作成する

#### タスク 1: (テナント ユーザーとして) 委任されたプロバイダーのオファーにサインアップする

このタスクでは、次のことを行います。

- (テナント ユーザーとして) 委任されたプロバイダーのオファーにサインアップする

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの InPrivate セッションを開始します。
1. Web ブラウザー ウィンドウを開き、(前の演習で特定した) 委任されたプロバイダーのポータル URL に移動してから、**t1u1@azurestack.local** としてサインインし、パスワードに **Pa55w.rd** と入力します。

    >**注**: ここでは、Azure Stack Hub ユーザー ポータル URL は絶対に使用しないでください。

1. Azure Stack Hub ユーザー ポータルで「**サブスクリプションの取得**」タイルをクリックします。
1. 「**サブスクリプションの取得**」ブレードの「**名前**」テキスト ボックスに「**t1u1-subscription1**」と入力します。
1. 「**サブスクリプションの取得**」ブレードで、「**dp1tot-services1-offer**」オファーを選択してから「**作成**」をクリックします。
1. 「**サブスクリプションが作成されました。サブスクリプションの使用を開始するに、ポータルを更新する必要があります**」のメッセージが表示されたら、「**更新**」をクリックします。

#### タスク 2: (テナント ユーザーとして) 新しいサブスクリプションのもとでリソースを作成する

このタスクでは、次のことを行います。

- (テナント ユーザーとして) 新しいサブスクリプションのもとでリソースを作成する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Azure Stack Hub ユーザー ポータルに **t1u1@azurestack.local** としてサインインした状態で、ハブ メニューの「**すべてのサービス**」をクリックしてから、「**すべてのサービス**」ブレードのサービスの一覧で「**サブスクリプション**」をクリックします。
1. 「**サブスクリプション**」ブレードで「**t1u1-subscription1**」をクリックします。
1. 「**t1u1-subscription1**」ブレードで「**リソース**」をクリックします。
1. 「**1u1-subscription1 \| リソース**」ブレードで「**+ 追加**」をクリックします。
1. 「**新規作成**」ブレードで「**データとストレージ**」をクリックし、リソースの種類の一覧で「**ストレージ アカウント**」をクリックします。
1. 「**ストレージ アカウントの作成**」ブレードの「**基本**」タブで、次のように設定を行います。

    - サブスクリプション: **t1u1-subscription1**
    - リソース グループ: 新しいリソース グループの名前 **delegated-RG**
    - ストレージ アカウント名: 3～24 の小文字または数字から成る一意の名前
    - 場所: **ローカル**
    - パフォーマンス: **Standard**
    - アカウントの種類: **ストレージ (汎用 v1)**
    - レプリケーション: **ローカル冗長ストレージ (LRS)**

1. 「**ストレージ アカウントの作成**」ブレードの「**基本**」タブで、「**次へ: 詳細 >**」をクリックします。
1. 「**ストレージ アカウントの作成**」ブレードの「**詳細**」タブで、設定を規定値にしたまま「**確認して作成**」をクリックします。
1. 「**ストレージ アカウントの作成**」ブレードの「**確認して作成**」タブで、「**作成**」を選択します。

    >**注**: ストレージ アカウントがプロビジョニングされるまで待ちます。通常 1 分ほどかかります。

1. ストレージ アカウントが正常に作成されたことを確認します。

>**確認**: この演習では、委任されたプロバイダーのオファーをサブスクライブすることで、新しいサブスクリプションを作成したほか、新しいサブスクリプションのもとでストレージ アカウントをプロビジョニングしました。
