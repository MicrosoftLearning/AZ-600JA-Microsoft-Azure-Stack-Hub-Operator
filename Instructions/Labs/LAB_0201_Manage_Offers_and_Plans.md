---
lab:
    title: 'Lab: Azure Stack Hub でオファーとプランを管理する'
    module: 'モジュール 2: サービスを提供する'
---

# ラボ - Azure Stack Hub でオファーとプランを管理する
# 受講生用ラボ マニュアル

## ラボの依存関係

- なし

## 推定所要時間

60 分

## ラボ シナリオ

あなたは Azure Stack Hub 環境のオペレーターとして、ユーザー向けにオファーとプランを実装する必要があります。すべてのユーザーが同一の基本サービス セットを受けられるようにする必要がありますが、同時に、一部のユーザーには追加サービスへのアクセスも付与したいと考えています。

## 目標

このラボを終了すると、次のことができるようになります。

- Azure Stack Hub 管理者ポータルを使用して、Azure Stack Hub のオファーとプランを実装する

## ラボ環境 

ラボ環境は、次のコンポーネントから構成されています。

- 次のアクセス ポイントを持つ、**AzS-HOST1** サーバーで実行されている ASDK デプロイ。

  - 管理者ポータル: https://adminportal.local.azurestack.external
  - 管理者 ARM エンドポイント: https://adminmanagement.local.azurestack.external
  - ユーザー ポータル: https://portal.local.azurestack.external
  - ユーザー ARM エンドポイント: https://management.local.azurestack.external

- 管理ユーザー:

  - ASDK クラウド オペレーターのユーザー名: **CloudAdmin@azurestack.local**
  - ASDK クラウド オペレーターのパスワード: **Pa55w.rd1234**
  - ASDK ホスト管理者のユーザー名: **AzureStackAdmin@azurestack.local**
  - ASDK ホスト管理者のパスワード: **Pa55w.rd1234**

このラボでは、追加のユーザー アカウントを作成します。


### 演習 0: ラボの準備を行う

この演習では、ラボで使用するための Active Directory ユーザー アカウントを作成します。

1. (クラウド オペレーターとして) ユーザー アカウントを作成する


#### タスク 1: (クラウド オペレーターとして) 最初のユーザー アカウントを作成する

1. 必要であれば、次の資格情報を使用して **AzS-HOST1** にサインインします。

    - ユーザー名: **AzureStackAdmin@azurestack.local**
    - パスワード: **Pa55w.rd1234**

1. **AzS-HOST1** へのリモート デスクトップ セッション内でスタート メニューから「**スタート**」をクリックし、「**Windows 管理ツール**」をクリックしてから、管理ツールの一覧で「**Active Directory 管理センター**」をダブルクリックします。
1. 「**Active Directory 管理センター**」コンソールで「**azurestack (ローカル)**」をクリックします。
1. 詳細ペインで「**ユーザー**」コンテナーをダブルクリックします。
1. 「**タスク**」ペインの「**ユーザー**」セクションで、**「新規作成」>「ユーザー」**の順にクリックします。
1. 「**ユーザーの作成**」ウィンドウで、次のように設定してから「**OK**」をクリックします。 

    - 完全名: **T1U1**
    - ユーザー UPN ログオン: **t1u1@azurestack.local**
    - ユーザー SamAccountName: **azurestack\t1u1**
    - パスワード: **Pa55w.rd**
    - パスワード オプション: **その他のパスワード オプション -> パスワードを無期限にする**

1. 上記のステップ 5～6 を繰り返し、次のように設定された別のユーザー アカウントを作成します。

    - 完全名: **T1U2**
    - ユーザー UPN ログオン: **t1u2@azurestack.local**
    - ユーザー SamAccountName: **azurestack\t1u2**
    - パスワード: **Pa55w.rd**
    - パスワード オプション: **その他のパスワード オプション -> パスワードを無期限にする**

>**確認**: この演習では、ラボで使用するための Active Directory ユーザー アカウントを作成しました。

### 演習 1: (クラウド オペレーターとして) オファーを作成する

この演習ではクラウド オペレーターとして、コンピューティング、ストレージ、ネットワークのサービスから構成されるプランを作成するほか、このプランが含まれるオファーを作成します。続いて、オファーをパブリックに設定することで、ユーザーがこのオファーに基づいてサブスクリプションを作成できるようにします。 
この演習は以下のタスクから構成されます。

1. (クラウド オペレーターとして) コンピューティング、ストレージ、ネットワークのサービスから構成されるプランを作成する
1. (クラウド オペレーターとして) プランに基づいたパブリック オファーを作成する
1. (クラウド オペレーターとして) プランに基づいたプライベート オファーを作成する

#### タスク 1: (クラウド オペレーターとして) コンピューティング、ストレージ、ネットワークのサービスから構成されるプランを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) コンピューティング、ストレージ、ネットワークのサービスから構成されるプランを 2 つ作成する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーを開いて画面に [Azure Stack Hub 管理者ポータル](https://adminportal.local.azurestack.external/)を表示させ、CloudAdmin@azurestack.local としてサインインします。
1. Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**+ リソースの作成**」をクリックします。
1. 「**新規作成**」ブレードで、「**オファーとプラン**」をクリックしてから「**プラン**」をクリックします。
1. 「**新しいプラン**」ブレードの「**基本**」タブで、次のように設定を行います。

    - 表示名: **base-plan1**
    - リソース名: **base-plan1**
    - リソース グループ: 新しいリソース グループの名前 **base-plans-RG**

1. 「**次へ: サービス >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**サービス**」タブで、「**Microsoft.Compute**」、「**Microsoft.Storage**」、「**Microsoft.Network**」のチェックボックスをオンにします。
1. 「**次へ: クォータ >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**クォータ**」タブで、次のように設定を行います。

    - Microsoft.Compute: **既定のクォータ**
    - Microsoft.Storage: **既定のクォータ**
    - Microsoft.Network: **既定のクォータ**

1. 「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。

1. Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**+ リソースの作成**」をクリックします。
1. 「**新規作成**」ブレードで、「**オファーとプラン**」をクリックしてから「**プラン**」をクリックします。
1. 「**新しいプラン**」ブレードの「**基本**」タブで、次のように設定を行います。

    - 表示名: **base-plan2**
    - リソース名: **base-plan2**
    - リソース グループ: 新しいリソース グループの名前 **base-plans-RG**

1. 「**次へ: サービス >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**サービス**」タブで、「**Microsoft.Compute**」、「**Microsoft.Storage**」、「**Microsoft.Network**」のチェックボックスをオンにします。
1. 「**次へ: クォータ >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**クォータ**」タブで、「**Microsoft.Compute**」ドロップダウン リストの横にある「**新規作成**」をクリックします。
1. 「**コンピューティング クォータの作成**」ブレードで、次のように設定してから「**OK**」をクリックします。

    - 名前: **base-plan1-compute-quota**
    - 仮想マシンの数: **40**
    - 仮想マシンのコアの数: **100**
    - 可用性セットの数: **20**
    - 仮想マシンのスケール セットの数: **40**
    - Standard マネージド ディスクの容量 (GB): **4096**
    - Premium マネージド ディスクの容量 (GB)**4096**

1. 「**新しいプラン**」ブレードの「**クォータ**」タブに戻り、「**Microsoft.Storage**」ドロップダウン リストの横にある「**新規作成**」をクリックします。
1. 「**ストレージ クォータの作成**」ブレードで、次のように設定してから「**OK**」をクリックします。

    - 名前: **base-plan1-storage-quota**
    - 最大容量 (GB): **4096**
    - ストレージ アカウントの合計数: **40**

1. 「**新しいプラン**」ブレードの「**クォータ**」タブに戻り、「**Microsoft.Network**」ドロップダウン リストの横にある「**新規作成**」をクリックします。
1. 「**ネットワーク クォータの作成**」ブレードで、次のように設定してから「**OK**」をクリックします。

    - 名前: **base-plan1-network-quota**
    - 仮想ネットワークの最大数: **100**
    - 仮想ネットワーク ゲートウェイの最大数: **2**
    - ネットワークの接続数: **4**
    - パブリック IP の最大数: **100**
    - NIC の最大数: **200**
    - ロード バランサーの最大数: **100**
    - ネットワーク セキュリティ グループの最大数: **100**

1. 「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。


#### タスク 2: (クラウド オペレーターとして) プランに基づいたパブリック オファーを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) プランに基づいたパブリック オファーを作成する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**+ リソースの作成**」をクリックします。 
1. 「**新規作成**」ブレードで、「**オファーとプラン**」をクリックしてから「**オファーと**」をクリックします。
1. 「**新しいオファーの作成**」ブレードの「**基本**」タブで、次のように設定を行います。

    - 表示名: **base-offer1**
    - リソース名: **base-offer1**
    - リソース グループ: **base-offers-RG**
    - このオファーをパブリックに設定する: **はい**

1. 「**次へ: 基本プラン >**」をクリックします。 
1. 「**新しいオファーの作成**」ブレードの「**基本プラン**」タブで、「**base-plan1**」エントリの横にあるチェックボックスをオンにします。
1. 「**次へ: アドオン プラン >**」をクリックします。
1. 「**アドオン プラン**」の設定は既定値にしたまま、「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。


#### タスク 3: (クラウド オペレーターとして) プランに基づいたプライベート オファーを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) プランに基づいたプライベート オファーを作成する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されている状態で、「**+ リソースの作成**」をクリックします。 
1. 「**新規**」ブレードで「**オファーとプラン**」をクリックします。
1. 「**オファーとプラン**」ブレードで「**オファー**」をクリックします
1. 「**新しいオファーの作成**」ブレードの「**基本**」タブで、次のように設定を行います。

    - 表示名: **base-offer2**
    - リソース名: **base-offer2**
    - リソース グループ: **base-offers-RG**
    - このオファーをパブリックに設定する: **いいえ**

1. 「**次へ: 基本プラン >**」をクリックします。 
1. 「**新しいオファーの作成**」ブレードの「**基本プラン**」タブで、「**base-plan2**」エントリの横にあるチェックボックスをオンにします。
1. 「**次へ: アドオン プラン >**」をクリックします。
1. 「**アドオン プラン**」の設定は既定値にしたまま、「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。

>**確認**: この演習では、プランを作成した後、このプランに基づいて 2 つのオファーを作成し、その一方をパブリックに、他方をプライベートに設定しました。


### 演習 2: (ユーザーとして) オファーに基づいたサブスクリプションを作成する

この演習では、前の演習で作成した、2 つのオファーに基づいたサブスクリプションを作成します。この演習は以下のタスクから構成されます。

1. (最初のユーザーとして) オファーにサインアップする
1. (オペレーターとして) 2 番目のユーザーにサブスクリプションを割り当てる

#### タスク 1: (最初のユーザーとして) オファーにサインアップする

このタスクでは、次のことを行います。

- (最初のユーザーとして) オファーにサインアップする

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの InPrivate セッションを開始します。
1. Web ブラウザー ウィンドウで [Azure Stack Hub ユーザー ポータル](https://portal.local.azurestack.external)に移動した後、**t1u1@azurestack.local** としてサインインし、パスワードに **Pa55w.rd** と入力します。
1. Azure Stack Hub ユーザー ポータルのダッシュボードで、「**サブスクリプションの取得**」タイルをクリックします。
1. 「**サブスクリプションの取得**」ブレードの「**名前**」テキスト ボックスに「**t1u1-base-subscription1**」と入力します。
1. オファーの一覧で「**base-offer1**」を選択し、「**作成**」をクリックします。
1. 「**サブスクリプションが作成されました。サブスクリプションの使用を開始するに、ポータルを更新する必要があります**」のメッセージが表示されたら、「**更新**」をクリックします。 
1. Azure Stack Hub テナント パネルのハブ メニューで、「**すべてのサービス**」をクリックします。
1. サービスの一覧で「**サブスクリプション**」をクリックします。
1. 「**サブスクリプション**」ブレードで「**t1u1-base-subscription1**」をクリックします。
1. 「**t1u1-base-subscrption1**」ブレードで「**リソース**」をクリックします。
1. 「**t1u1-base-subscrption1 - リソース**」ブレードで「**+ 追加**」をクリックします。
1. 「**新規作成**」ブレードで、「**セキュリティと ID**」をクリックしてから「**Key Vault**」をクリックします。
1. 「**Key Vault の作成**」ブレードの「**基本**」タブで、次のように設定を行います (他の設定は既定値のままにします)。

    - リソース グループ: 新しいリソース グループの名前 **kv-RG**
    - Key Vault 名: 3 ～ 24 文字の英数字とダッシュから成る、英字で始まる一意の名前

1. 「**確認して作成**」をクリックしてから「**作成**」をクリックします。
1. デプロイに失敗したことを確認します。 

    >**注**: 「**リソース名前空間 'Microsoft.KeyVault' は無効です**」のエラー メッセージを確認します。この Key Vault はオファーに含まれていないため、作成することはできません。

1. Azure Stack Hub ユーザー ポータルからサインアウトし、Web ブラウザーの InPrivate セッションを閉じます。

#### タスク 2: (オペレーターとして) 2 番目のユーザーにサブスクリプションを割り当てる

このタスクでは、次のことを行います。

- (オペレーターとして) 2 番目のユーザーにサブスクリプションを割り当てる

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの画面に [Azure Stack Hub 管理者ポータル](https://adminportal.local.azurestack.external/)が表示されている状態で、CloudAdmin@azurestack.local にサインインし、「**すべてのリソース**」を選択します。
1. 「**すべてのサービス**」ブレードで「**base-offer2**」を検索して選択します。
1. 「**base-offer2**」ブレードで「**サブスクリプション**」を選択します。
1. 「**base-offer2 \| サブスクリプション**」ブレードで「**+ 追加**」をクリックします。
1. 「**ユーザー サブスクリプションの作成**」ブレードで、次のように設定してから「**作成**」を選択します。

    - 名前: **t1u2-base-subscription1**
    - ユーザー: **t1u2@azurestack.local**
    - ディレクトリ テナント: **ADFS.azurestack.local**
    - オファー名: **base-offer2**

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの InPrivate セッションを開始します。
1. Web ブラウザー ウィンドウで [Azure Stack Hub ユーザー ポータル](https://portal.local.azurestack.external)に移動した後、**t1u2@azurestack.local** としてサインインし、パスワードに **Pa55w.rd** と入力します。
1. Azure Stack Hub ユーザー ポータルのハブ メニューで「**すべてのサービス**」を選択してから、「**すべてのサービス**」ブレードで「**サブスクリプション**」を選択します。
1. 「**サブスクリプション**」ブレードで「**t1u2-base-subscription1**」を選択します。
1. 「**t1u2-base-subscrption1**」ブレードで「**リソース**」をクリックします。
1. 「**t1u2-base-subscrption1 - リソース**」ブレードで「**+ 追加**」をクリックします。
1. 「**新規作成**」ブレードで、「**セキュリティと ID**」をクリックしてから「**Key Vault**」をクリックします。
1. 「**Key Vault の作成**」ブレードの「**基本**」タブで、次のように設定を行います (他の設定は既定値のままにします)。

    - リソース グループ: 新しいリソース グループの名前 **kv-RG**
    - Key Vault 名: 3 ～ 24 文字の英数字とダッシュから成る、英字で始まる一意の名前

1. 「**確認して作成**」をクリックしてから「**作成**」をクリックします。
1. デプロイに失敗したことを確認します。 

    >**注**: 「**リソース名前空間 'Microsoft.KeyVault' は無効です**」のエラー メッセージを確認します。この Key Vault はオファーに含まれていないため、作成することはできません。

1. Azure Stack Hub ユーザー ポータルからサインアウトし、Web ブラウザーの InPrivate セッションを閉じます。

>**確認**: この演習では、2 人のユーザーとしてオファーをサブスクライブすることで、2 つの新しいユーザー サブスクリプションを作成しました。


### 演習 3: (クラウド オペレーターとして) アドオンプランを作成し、これをユーザー サブスクリプションに割り当てる

この演習ではクラウド オペレーターとして、Key Vault サービスから構成されるアドオン プランを作成します。次に、これをいずれか 1 つのユーザー サブスクリプションに割り当てます。 

1. (クラウド オペレーターとして) Key Vault サービスが含まれるアドオン プランを作成する
1. (クラウド オペレーターとして) アドオン プランを既存のオファーに割り当てる

#### タスク 1: (クラウド オペレーターとして) Key Vault サービスが含まれるアドオン プランを作成する

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) Key Vault サービスから構成されるアドオン プランを作成する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されており、CloudAdmin@azurestack.local にサインインしている状態で、「**+ リソースの作成**」をクリックします。 
1. 「**新規**」ブレードで「**オファーとプラン**」をクリックします。
1. 「**オファーとプラン**」ブレードで「**プラン**」をクリックします
1. 「**新しいプラン**」ブレードで、次のように設定を行います。

    - 表示名: **add-on-plan2**
    - リソース名: **add-on-plan2**
    - リソース グループ: 新しいリソース グループの名前 **add-on-plans-RG**

1. 「**次へ: サービス >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**サービス**」タブで、「**Microsoft.KeyVault**」チェックボックスをオンにします。
1. 「**次へ: クォータ >**」をクリックします。
1. 「**新しいプラン**」ブレードの「**クォータ**」タブで、「**Microsoft.KeyVault**」ドロップダウン リストから「**無制限**」を選択します。
1. 「**確認して作成**」をクリックしてから「**作成**」をクリックします。

    >**注**: デプロイが完了するまで待ちます。通常は数秒で完了します。


#### タスク 2: (クラウド オペレーターとして) アドオン プランを既存のオファーに割り当てる

このタスクでは、次のことを行います。

- (クラウド オペレーターとして) アドオン プランを既存のオファーに割り当てる

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの画面に Azure Stack Hub 管理者ポータルが表示されており、CloudAdmin@azurestack.local にサインインしている状態で、「**すべてのリソース**」をクリックします。 
1. リソースの一覧で「**base-offer2**」を検索して選択します。
1. 「**base-offer2**」ブレードで「**アドオン プラン**」を選択します。
1. 「**base-offer2 \| アドオン プラン**」ブレードで「**+ 追加**」をクリックします。
1. 「**プラン**」ブレードで「**add-on-plan2**」をクリックし、「**選択**」をクリックします。 

>**確認**: この演習ではアドオン プランを作成し、これを (2 番目のユーザーのサブスクリプションに関連付けられている) 既存のオファーに割り当てました。


### 演習 4: (2 番目のユーザーとして) アドオン プランの可用性を確認する

この演習ではユーザーとして、最初の演習で作成したオファーにサインアップした後、新しいサブスクリプションを作成します。この演習は以下のタスクから構成されます。

1. (2 番目のユーザーとして) アドオン プランを追加することでサブスクリプションを修正する
1. (2 番目のユーザーとして) アドオン プランの機能を確認する

#### タスク 1: (2 番目のユーザーとして) アドオン プランを追加することでサブスクリプションを修正する

このタスクでは、次のことを行います。

- (2 番目のユーザーとして) アドオン プランの可用性を確認する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの InPrivate セッションを開始します。
1. Web ブラウザー ウィンドウで [Azure Stack Hub ユーザー ポータル](https://portal.local.azurestack.external)に移動した後、**t1u1@azurestack.local** としてサインインし、パスワードに **Pa55w.rd** と入力します。
1. Azure Stack Hub ユーザー ポータルのハブ メニューで、「**すべてのサービス**」をクリックします。
1. サービスの一覧で「**サブスクリプション**」をクリックします。
1. 「**サブスクリプション**」ブレードで「**t1u2-base-subscription1**」をクリックします。
1. 「**t1u2-base-subscription1**」ブレードで「**+ プランの追加**」をクリックします。
1. 「**プランの追加**」ブレードで「**add-on-plan2**」を選択します。Azure Stack ユーザー ポータルが表示されている Web ブラウザーのページを更新するように求められたら、これを実行します。
1. 「**t1u2-base-subscription1**」ブレードに戻り、「**アドオン プラン**」をクリックします。
1. 「**t1u2-base-subscription2 | アドオン プラン**」ブレードで、**add-on-plan2** を示すエントリを確認します。

#### タスク 2: (2 番目のユーザーとして) アドオン プランの機能を確認する

このタスクでは、次のことを行います。

- (2 番目のユーザーとして) アドオン プランの可用性を確認する

1. **AzS-HOST1** へのリモート デスクトップ セッション内で、Web ブラウザーの InPrivate セッションに Azure Stack Hub ユーザー ポータルが表示されている状態で、t1u2@azurestack.local としてサインインします。 
1. 「**t1u2-base-subscrption1**」ブレードで「**リソース**」をクリックします。
1. 「**t1u2-base-subscrption1 - リソース**」ブレードで「**+ 追加**」をクリックします。
1. 「**新規作成**」ブレードで、「**セキュリティと ID**」をクリックしてから「**Key Vault**」をクリックします。
1. 「**Key Vault の作成**」ブレードの「**基本**」タブで、次のように設定を行います (他の設定は既定値のままにします)。

    - リソース グループ: **kv-RG**
    - Key Vault 名: 3 ～ 24 文字の英数字とダッシュから成る、英字で始まる一意の名前

1. 「**確認して作成**」をクリックしてから「**作成**」をクリックします。
1. デプロイが成功したことを確認します。
1. Azure Stack Hub ユーザー ポータルからサインアウトし、Web ブラウザーの InPrivate セッションを閉じます。

>**確認**: この演習では、アドオン プランの機能について確認しました。
